<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Hustle 17K</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>

.loginLogo {
  display: block;
  margin: 0 auto 16px auto;
  max-width: 160px;
  width: 100%;
  height: auto;
}

:root{
  --bg:#071a3a;          /* deep royal blue */
  --panel:#0b244a;       /* navy panel */
  --panel2:#081d3f;
  --border:rgba(245,200,76,.28);
  --text:#FFFFFF;
  --muted:rgba(255,255,255,.78);
  --accent:#0A2B5F;      /* deep navy */      /* championship gold */
  --danger:#c81d25;      /* red */
  --secondary:#0A2B5F;   /* deep navy */   /* blue secondary */
  --green:#F5C84C;       /* progress gold */
  --routeLine: rgba(47,128,255,.95); /* arena blue */
}


*{ box-sizing:border-box; }
  body { margin:0; font-family:Inter, Arial, sans-serif; background:var(--bg); color:var(--text); }
  section { width:100%; min-height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:16px 0; }

  button { padding:14px 18px; font-size:16px; background:var(--accent); color:white; border:none; border-radius:14px; cursor:pointer; font-weight:900; }
  button:disabled{ opacity:.45; cursor:not-allowed; }
  input { padding:12px; font-size:16px; border-radius:14px; border:1px solid #333; background:var(--panel); color:var(--text); width:100%; }

  .panel { padding:12px; width:92vw; max-width:900px; }
  .leaflet-div-icon { background:transparent !important; border:none !important; }

  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:7px 10px; border-radius:999px;
    border:1px solid var(--border);
    background:rgba(255,255,255,0.03);
    font-size:12px; font-weight:800; white-space:nowrap;
  }
  .pillBtn{
    background:transparent;
    border:1px solid var(--border);
    color:var(--text);
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:900;
    cursor:pointer;
  }

  /* Map */
  #mapWrap{
    width:92vw;
    max-width:900px;
    margin-top:10px;
    position:relative;
  }
  #map {
    height:56vh;
    width:100%;
    border:2px solid var(--accent);
    border-radius:18px;
    overflow:hidden;
    background:var(--bg);
  }
  /* Helps page scroll when map is locked */
  #map.map-locked{ touch-action: pan-y !important; }
  #map.map-unlocked{ touch-action: none !important; }

  .mapLoading{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:rgba(10,10,15,.88);
    border-radius:18px;
    z-index:999;
    padding:14px;
  }
  .mapLoadingCard{
    background:rgba(255,255,255,0.04);
    border:1px solid var(--border);
    padding:12px 14px;
    border-radius:14px;
    font-size:13px;
    color:var(--muted);
    width:min(84vw, 420px);
    text-align:center;
  }

  .mapControls{
    position:absolute;
    right:10px;
    bottom:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
    z-index:1000;
  }
  .mapCtrlBtn{
    background:rgba(15,15,20,0.9);
    border:1px solid var(--border);
    color:var(--text);
    padding:10px 12px;
    border-radius:14px;
    font-size:13px;
    font-weight:900;
    cursor:pointer;
    backdrop-filter: blur(6px);
  }

  /* Header */
  .topBar{
    width:92vw; max-width:900px;
    margin-top:4px;
    display:flex; flex-direction:column; align-items:center; gap:6px;
  }
  .topTitle{ font-size:28px; font-weight:900; letter-spacing:.2px; line-height:1.05; }
  .topSub{ font-size:13px; color:var(--muted); letter-spacing:.2px; }

  .whoRow{
    width:92vw; max-width:900px;
    margin-top:10px;
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  .helloLine{
    margin-top:8px;
    width:92vw; max-width:900px;
    font-size:16px; font-weight:800; opacity:.95;
    display:flex; align-items:center; justify-content:center; gap:8px;
  }
  .helloPill{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:999px;
    background:rgba(255,255,255,0.03);
    border:1px solid var(--border);
  }

  /* Progress card */
  .progressCard{
    width:92vw; max-width:900px;
    margin-top:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid var(--border);
    border-radius:18px;
    padding:12px 14px;
    text-align:left;
  }
  .progressTop{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; flex-wrap:wrap;
  }
  .progressLabel{ font-size:13px; color:var(--muted); font-weight:700; }
  .progressValue{ font-size:16px; font-weight:900; letter-spacing:.2px; }

  .bar{
    width:100%; height:10px; border-radius:999px;
    background:rgba(255,255,255,0.06);
    border:1px solid var(--border);
    overflow:hidden; margin-top:10px;
  }
  .barFill{
    height:100%; width:0%;
    background:var(--green);
    border-radius:999px;
    transition:width .35s ease;
  }
  .subRow{
    margin-top:10px;
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; flex-wrap:wrap;
  }
  .savedPill{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px;
    border:1px solid var(--border);
    background:var(--panel2);
    font-size:12px;
    opacity:0;
    transform:translateY(-2px);
    transition:opacity .18s ease, transform .18s ease;
  }
  .savedPill.show{ opacity:1; transform:translateY(0px); }
  .completePill{
    display:none;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#0f2a12;
    font-size:12px; font-weight:900;
  }
  .lastUpdate{
    font-size:12px;
    color:var(--muted);
    font-weight:700;
  }
  .nextMoment{
    margin-top:10px;
    font-size:13px;
    color:var(--muted);
    font-weight:800;
  }

  /* Toast */
  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:18px;
    background:var(--panel);
    border:1px solid var(--border);
    padding:10px 12px;
    border-radius:14px;
    opacity:0;
    pointer-events:none;
    transition:opacity .18s ease;
    z-index:99999;
    width:min(88vw, 520px);
    text-align:center;
    font-size:14px;
  }
  .toast.show{ opacity:1; }

  /* Controls */
  .controlsCard{
    width:92vw;
    max-width:900px;
    margin-top:12px;
    background:rgba(255,255,255,0.03);
    border:1px solid var(--border);
    border-radius:18px;
    padding:12px 14px;
  }
  .btnRow{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:nowrap;
  }
  .quickBtn{
    padding:12px 10px;
    border-radius:16px;
    font-size:16px;
    font-weight:900;
    margin:0;
    flex:1 1 0;
    min-width:0;
    max-width:220px;
    white-space:nowrap;
  }
  .inputRow{
    display:flex;
    gap:10px;
    justify-content:center;
    align-items:center;
    margin-top:10px;
    flex-wrap:nowrap;
  }
  .kmInput{
    width:240px;
    max-width:48vw;
    margin:0;
  }
  .addBtn{
    padding:12px 16px;
    margin:0;
    border-radius:16px;
    font-weight:900;
    white-space:nowrap;
  }
  .bottomRow{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:center;
    margin-top:10px;
    flex-wrap:nowrap;
  }
  .ghostBtn{
    background:var(--secondary);
    margin:0;
    padding:12px 14px;
    border-radius:16px;
    font-weight:900;
    flex:1 1 0;
    color:var(--text);
  }

  @media (max-width:380px){
    .quickBtn{ font-size:15px; padding:12px 8px; }
    .kmInput{ width:200px; }
  }

  /* Overlays */
  .overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,0.86);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
    padding:16px;
  }
  .overlay.show{ display:flex !important; }
  .card{
    width:min(92vw, 720px);
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:18px;
    padding:16px;
    box-shadow:0 18px 60px rgba(0,0,0,0.55);
    text-align:left;
  }

  /* Finish (tidied) */
  .finishCard{
    text-align:center;
    padding:18px 16px;
  }
  .finishTop{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    margin-bottom:6px;
  }
  .finishIcon{
    width:44px; height:44px;
    display:grid; place-items:center;
    border-radius:14px;
    border:1px solid var(--border);
    background:rgba(255,255,255,0.04);
    font-size:22px;
    box-shadow:0 0 0 2px rgba(255,255,255,0.02) inset;
  }
  .finishTitle{
    margin:0;
    font-size:34px;
    font-weight:900;
    letter-spacing:.2px;
    line-height:1.05;
  }
  .finishSub{
    margin:8px 0 0;
    opacity:.9;
    font-size:14px;
    line-height:1.45;
  }
  .finishStats{
    margin-top:12px;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:center;
  }
  .statPill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:rgba(255,255,255,0.03);
    font-size:12px;
    font-weight:800;
    white-space:nowrap;
  }
  .finishNext{
    margin-top:14px;
    text-align:left;
    border:1px solid var(--border);
    background:rgba(255,255,255,0.03);
    border-radius:16px;
    padding:12px 12px;
  }
  .finishNextTitle{
    font-weight:900;
    font-size:13px;
    letter-spacing:.2px;
    margin:0 0 8px 0;
  }
  .finishSteps{
    margin:0;
    padding-left:18px;
    color:var(--muted);
    font-size:13px;
    line-height:1.45;
  }
  .finishSteps b{ color:var(--text); }
  .finishHelp{
    margin-top:12px;
    text-align:left;
    border:1px solid var(--border);
    border-radius:16px;
    background:rgba(255,255,255,0.02);
    overflow:hidden;
  }
  .finishHelp summary{
    list-style:none;
    cursor:pointer;
    padding:12px 12px;
    font-weight:900;
    font-size:13px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .finishHelp summary::-webkit-details-marker{ display:none; }
  .finishHelp summary:after{
    content:"‚ñæ";
    opacity:.8;
  }
  .finishHelp[open] summary:after{ content:"‚ñ¥"; }
  .finishHelpBody{
    padding:0 12px 12px 12px;
    color:var(--muted);
    font-size:13px;
    line-height:1.45;
  }
  .copyRow{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
    margin:10px 0 6px;
    padding:10px 10px;
    border-radius:14px;
    border:1px solid var(--border);
    background:rgba(0,0,0,0.15);
  }
  .emailMono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-weight:900;
    color:var(--text);
    font-size:13px;
    word-break:break-all;
  }
  .copyBtn{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--border);
    background:var(--secondary);
    color:var(--text);
    font-weight:900;
    font-size:12px;
    cursor:pointer;
  }
  .finishButtons{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
    margin-top:14px;
  }
  .primaryBtn{ background:var(--accent); flex:1 1 220px; }
  .secondaryBtn{ background:var(--secondary); flex:1 1 160px; }
/* Login */
  .loginCard{
    width:min(92vw, 420px);
    background:rgba(255,255,255,0.03);
    border:1px solid var(--border);
    border-radius:18px;
    padding:18px 16px;
    box-shadow:0 18px 60px rgba(0,0,0,0.55);
    text-align:left;
  }
  .loginTitle{ font-size:26px; font-weight:900; margin:0; text-align:center; }
  .loginSub{ margin:8px 0 14px; opacity:.85; font-size:13px; text-align:center; }
  .fieldWrap{ position:relative; width:100%; }
  .pwToggle{
    position:absolute; right:10px; top:50%; transform:translateY(-50%);
    background:transparent; border:1px solid var(--border);
    color:var(--text); padding:6px 10px; border-radius:10px;
    font-size:12px; cursor:pointer; opacity:.9;
  }
  .warnLine{ margin-top:6px; opacity:.9; font-size:12px; text-align:center; }
  .warnLine b{ color:#ffd1d1; }
  .helpLine{ margin-top:10px; opacity:.75; font-size:12px; text-align:center; }

  /* Splash */
  .splashWrap{
    width:min(92vw, 520px);
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
  }
  .brandStack{
    display:flex;
    flex-direction:column;
    gap:4px;
    align-items:center;
    margin-bottom:4px;
  }
  .brandTitle{ font-size:28px; font-weight:900; letter-spacing:.4px; }
  .brandTag{ font-size:14px; opacity:.85; }
  .brandSite{ font-size:12px; opacity:.8; letter-spacing:1px; }

  .welcomeLine{
    font-size:40px;
    font-weight:900;
    margin-top:6px;
    line-height:1.05;
  }
  .nextLine{ font-size:13px; opacity:.8; margin-top:2px; }
  .progressLine{ margin-top:2px; font-size:16px; font-weight:900; opacity:.92; }
  .splashBtn{
    width:min(320px, 78vw);
    padding:16px 18px;
    font-size:18px;
    border-radius:16px;
    margin-top:4px;
  }

  /* Local storage notice */
  .localNotice{
    margin-top:14px;
    padding:12px 14px;
    border-radius:14px;
    background:rgba(255,255,255,0.07);
    border:1px solid var(--border);
    font-size:0.85rem;
    line-height:1.45;
    opacity:0.92;
    text-align:left;
  }
  .localNotice strong{
    display:block;
    margin-bottom:6px;
    font-weight:800;
  }
  .localNotice p{ margin:6px 0 0; }


  50%  { filter: drop-shadow(0 0 8px rgba(245,200,76,0.95)) drop-shadow(0 0 18px rgba(245,200,76,0.75)); }
  100% { filter: drop-shadow(0 0 5px rgba(245,200,76,0.75)) drop-shadow(0 0 10px rgba(245,200,76,0.45)); }
}


/* --- Cena Face (Retirement Tour) Premium Skin --- */
body{
  background:
    radial-gradient(900px 540px at 50% 0%, rgba(255,255,255,.08), transparent 60%),
    radial-gradient(900px 650px at 25% 18%, rgba(245,200,76,.14), transparent 62%),
    radial-gradient(900px 650px at 75% 22%, rgba(47,128,255,.10), transparent 64%),
    linear-gradient(180deg, #071a3a, #051229);
}

/* Spotlight glow behind the top area */
.topBar{
  position:relative;
}
.topBar:before{
  content:"";
  position:absolute;
  inset:-18px -18px auto -18px;
  height:140px;
  background: radial-gradient(ellipse at center, rgba(255,255,255,.10) 0%, rgba(245,200,76,.10) 28%, transparent 70%);
  filter: blur(2px);
  pointer-events:none;
  z-index:-1;
}

/* Softer, premium card glow (less harsh shadow) */
.progressCard, .controlsCard, .loginCard, .card{
  box-shadow:
    0 18px 60px rgba(0,0,0,.45),
    0 0 0 1px rgba(245,200,76,.10) inset;
}

/* Buttons: charcoal + gold border (less blocky) */
button{
  background:
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18)),
    rgba(12,18,35,.95);
  border:1px solid rgba(245,200,76,.55);
  color:var(--text);
  border-radius:16px;
}
button:hover{ filter:brightness(1.06); }

.primaryBtn{
  background: linear-gradient(135deg, rgba(245,200,76,1), rgba(255,230,150,1), rgba(210,160,45,1));
  border:none;
  color:#151824;
}
.pillBtn, .mapCtrlBtn{
  border-radius:999px;
}

/* Title typography: classy hero vibe */
.topTitle, .brandTitle, .loginTitle{
  letter-spacing:1.6px;
  text-transform:uppercase;
}

/* Map frame: crisp + premium */
#map{
  border:2px solid rgba(245,200,76,.65);
  box-shadow:
    0 0 0 1px rgba(0,0,0,.45) inset,
    0 0 24px rgba(245,200,76,.18);
}

/* Progress bar: metallic sweep */
.barFill{
  position:relative;
  overflow:hidden;
  background: linear-gradient(90deg, rgba(210,160,45,1), rgba(255,230,150,1), rgba(245,200,76,1));
  box-shadow: 0 0 18px rgba(245,200,76,.22);
}
.barFill:after{
  content:"";
  position:absolute; inset:0;
  background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,.22) 35%, transparent 70%);
  transform: translateX(-120%);
  animation: cenaShine 3.6s ease-in-out infinite;
}
@keyframes cenaShine{
  0%{ transform: translateX(-120%); }
  45%{ transform: translateX(120%); }
  100%{ transform: translateX(120%); }
}

/* Trail glow: a bit cleaner (emotional/premium) */
.shiny-route{
  filter: drop-shadow(0 0 6px rgba(245,200,76,0.75)) drop-shadow(0 0 14px rgba(245,200,76,0.45));
  animation: sparkleGlow 2.4s ease-in-out infinite;
}
@keyframes sparkleGlow{
  0%   { filter: drop-shadow(0 0 5px rgba(245,200,76,0.65)) drop-shadow(0 0 12px rgba(245,200,76,0.35)); }
  50%  { filter: drop-shadow(0 0 9px rgba(245,200,76,0.90)) drop-shadow(0 0 20px rgba(245,200,76,0.55)); }
  100% { filter: drop-shadow(0 0 5px rgba(245,200,76,0.65)) drop-shadow(0 0 12px rgba(245,200,76,0.35)); }
}

</style>
</head>

<body>
<div id="toast" class="toast"></div>

<!-- LOGIN -->

<section id="auth">
  <div class="loginCard">
    <h1 class="loginTitle">THE HUSTLE 17K</h1>
    <div class="loginSub">Enter your login code to track your The Hustle 17K progress.</div>

    <div class="fieldWrap">
      <input id="accessCode" placeholder="Login code" autocomplete="one-time-code" />
    </div>

    <div class="warnLine">üîë Your code is <b>case sensitive</b>.</div>

    <button id="loginBtn" onclick="login()" style="width:100%; margin-top:12px;">Continue</button>

    <div class="helpLine">Need your code? Message the organiser.</div>
  </div>
</section>

<!-- SPLASH -->

<section id="splash" style="display:none">
  <div class="splashWrap">
    <div class="brandStack">
      <div class="brandTitle">The Hustle 17K</div>
      <div class="brandTag">walk, run, wrestle</div>
      <div class="brandSite">WRW.COM</div>
    </div>

    <div class="whoRow" style="justify-content:center;">
      <span class="pill">‚úÖ Logged in: <span id="whoSplash" class="mono"></span></span>
      <button class="pillBtn" onclick="logoutConfirm()">Log out</button>
</div>

    <div class="welcomeLine">Welcome <span id="userName"></span></div>
    
    <div style="width:min(360px, 82vw); margin-top:10px; text-align:left;">
      <div style="font-weight:900; font-size:13px; margin:0 0 6px 2px; opacity:.95;">Add name</div>
      <input id="displayNameInput" placeholder="Your name (optional)" maxlength="40" />
      <button id="saveNameBtn" type="button" onclick="saveDisplayName()" style="width:100%; margin-top:8px;">Save name</button>
      <div style="margin-top:6px; font-size:12px; opacity:.8; line-height:1.35;">
        This is the name shown inside the app. Your login username stays private.
      </div>
    </div>

<div id="splashProgress" class="progressLine">Progress: 0.00 / 17.00 km</div>
    <div class="nextLine">Tap Continue to open the map and log your distance.</div>
    <div class="localNotice">
      <strong>Progress saved on your device</strong>
      <p>This app stores your run progress locally on your phone or browser.</p>
      <p>We don‚Äôt track your activity, build databases, or collect runner data ‚Äî it simply runs on your device to support your run.</p>
      <p>Clearing browser data or switching devices will reset your progress.</p>
      <p>When you finish, submit your proof by email as instructed.</p>
    </div>


    <button id="startBtn" class="splashBtn" onclick="startRun()">Continue</button>
  </div>
</section>

<!-- RUN -->
<section id="run" style="display:none; justify-content:flex-start;">
  <div class="topBar">
    <div class="topTitle">The Hustle 17K</div>
    <div class="topSub"></div>
  </div>

  <div class="whoRow">
    <span class="pill">‚úÖ Logged in: <span id="whoRun" class="mono"></span></span>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="pillBtn" onclick="openHelp()">?</button>
<button class="pillBtn" onclick="logoutConfirm()">Log out</button>
    </div>
  </div>

  <div class="helloLine">
    <div class="helloPill">üëã <span id="helloName">Hello</span></div>
  </div>

  <div class="progressCard">
    <div class="progressTop">
      <div class="progressLabel">Progress</div>
      <div class="progressValue"><span id="total">0.00</span> / 17.00 km</div>
    </div>
    <div class="bar"><div id="barFill" class="barFill"></div></div>

    <div class="subRow">
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <span id="completePill" class="completePill">‚úÖ Completed</span>
        <span id="savedPill" class="savedPill">‚úÖ Saved</span>
      </div>
      <div class="lastUpdate">Last update: <span id="lastUpdateText">‚Äî</span></div>
    </div>

    <div class="nextMoment" id="nextMomentText">Next Hustle rep in: ‚Äî</div>
  </div>

  <div id="mapWrap">
    <div id="map" class="map-locked"></div>

    <div class="mapControls">
      <button class="mapCtrlBtn" id="mapLockBtn" onclick="toggleMapLock()">Unlock map</button>
      <button class="mapCtrlBtn" onclick="fitRoute()">Fit route</button>
      <button class="mapCtrlBtn" onclick="recenter()">Recenter</button>
    </div>

    <div id="mapLoading" class="mapLoading">
      <div class="mapLoadingCard">
        Loading map‚Ä¶ if this takes ages, zoom once (+) and it usually wakes up.
      </div>
    </div>
  </div>

  <div class="controlsCard">
        <div class="btnRow">
      <button class="quickBtn" onclick="requestQuick(1, this)">+1 km</button>
    </div>

    <div class="bottomRow">
      <button id="undoBtn" class="ghostBtn" onclick="undoLast()" disabled>Undo</button>
    </div>

    <div style="margin-top:10px; display:flex; justify-content:center;">
      <button class="pillBtn" onclick="backToTop()">Back to top ‚Üë</button>
    </div>
  </div>

  <div style="height:24px;"></div>
</section>

<!-- FINISH -->
<div class="overlay" id="finishOverlay" role="dialog" aria-modal="true">
  <div class="card finishCard">
    <div class="finishTop">
      <div class="finishIcon">üéâ</div>
    </div>

    <div class="finishTitle">WELL DONE!</div>
    <p class="finishSub">
      <b id="finishUser">You</b> completed <b>The Hustle 17K</b>
    </p>

    <div class="finishStats">
      <span class="statPill">üèÅ Total: <b id="finishTotal">0.00</b> km</span>
      <span class="statPill">üïí Completed: <b id="finishWhen">‚Äî</b></span>
    </div>

    <div class="finishNext">
      <div class="finishNextTitle">Next step to claim your medal</div>
      <ol class="finishSteps">
        <li>Tap <b>Send proof</b> to open an email to us.</li>
        <li>Attach a screenshot/activity proof from your tracker (e.g. Strava/Garmin/Apple/Samsung) showing your <b>distance</b> and <b>date</b>.</li>
        <li>Send it ‚Äî this is the <b>only</b> way we can verify your run and count you as a finisher.</li>
      </ol>
    </div>

    <details class="finishHelp">
      <summary>Send Proof not working on PC?</summary>
      <div class="finishHelpBody">
        Some computers don‚Äôt support automatic email links. If the button doesn‚Äôt open your email app, send your proof manually to:
        <div class="copyRow">
          <span class="emailMono" id="proofEmail">Log.walkrunwrestle@gmail.com</span>
          <button class="copyBtn" type="button" onclick="copyProofEmail()">Copy</button>
        </div>
        Include your FULL NAME and FIRST LINE OF YOUR ADDRESS and attach your proof in the email.
      </div>
    </details>

    <div class="finishButtons">
      <button class="primaryBtn" onclick="emailToWRW()">Send proof</button>
      <button class="secondaryBtn" onclick="closeFinish()">Back to map</button>
    </div>
  </div>
</div>

<!-- HELP -->
<div class="overlay" id="helpOverlay">
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <div style="font-weight:900; font-size:18px;">Quick help</div>
      <button class="ghostBtn" onclick="closeHelp()">Close</button>
    </div>

    <ul style="margin:10px 0 0; padding-left:18px; color:var(--muted); font-size:13px; line-height:1.45;">
      <li>Use the <b>+1 km</b> button each time you complete a 1 km session (17 times total).</li>
      <li>Your progress <b>auto-saves on this device</b>.</li>
      <li><b>Send proof</b> opens an email draft ‚Äî please attach <b>screenshots and/or proof</b> before sending.</li>
      <li><b>Map is locked by default</b> so the page scrolls. Tap <b>Unlock map</b> to move/zoom it.</li>
      <li>Use <b>Fit route</b> / <b>Recenter</b> if the map moves around.</li>
    </ul>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      <button class="ghostBtn" onclick="fitRoute(); closeHelp();">Fit route</button>
      <button class="ghostBtn" onclick="recenter(); closeHelp();">Recenter</button>
      <button class="ghostBtn" onclick="toggleMapLock();">Toggle lock</button>
    </div>
  </div>
</div>

<script>
/* ACCESS */
const ACCESS_CODE = "Hustle1";
const RACE_NAME = "The Hustle 17K";

/* Run rules */
const CHALLENGE_KM = 17;
const MAP_ROUTE_KM = 51;               // hidden (ratio 1k logged = 3k on map)
const TARGET_ROUTE_METERS = MAP_ROUTE_KM * 1000;
const POPUP_DELAY_MS = 5000;

const refs = [
  "1km: Hustle. Loyalty. Respect. Let‚Äôs go.",
  "2km: Keep it clean ‚Äî consistency wins.",
  "3km: You can‚Äôt see me‚Ä¶ but you can feel the grind.",
  "4km: Stay sharp. Stay steady.",
  "5km: Halfway to 10? Nah ‚Äî you‚Äôre building a legacy.",
  "6km: One more rep. One more round.",
  "7km: Pace locked. Head up.",
  "8km: No shortcuts. Just hustle.",
  "9km: You‚Äôve done the hard part ‚Äî keep stacking.",
  "10km: Double digits. Champion mindset.",
  "11km: Breathe. Reset. Push on.",
  "12km: Respect the work ‚Äî finish the job.",
  "13km: Momentum is yours now.",
  "14km: Pain is temporary. Pride is forever.",
  "15km: Final stretch prep ‚Äî stay in it.",
  "16km: One left. Empty the tank.",
  "17km: üèÅ THE HUSTLE COMPLETE ‚Äî YOU DID IT."
];

function getData(){ return JSON.parse(localStorage.getItem("hustle_users") || "{}"); }
function saveData(d){ localStorage.setItem("hustle_users", JSON.stringify(d)); }
function getUser(){ return sessionStorage.getItem("hustle_user"); }
function getRole(){ return sessionStorage.getItem("hustle_role"); }

function getDisplayName(u){
  const data = getData();
  const raw = data && data[u] && typeof data[u].displayName === "string" ? data[u].displayName.trim() : "";
  return raw || u;
}
function saveDisplayName(){
  const u = getUser();
  if (!u) return;

  const input = document.getElementById("displayNameInput");
  const name = (input?.value || "").trim();

  const data = getData();
  if (!data[u]) return;

  data[u].displayName = name;
  saveData(data);

  // Refresh UI where the name is shown
  const shown = getDisplayName(u);
  const elSplashName = document.getElementById("userName");
  const elWhoSplash  = document.getElementById("whoSplash");
  const elWhoRun     = document.getElementById("whoRun");
  const elHello      = document.getElementById("helloName");
  const elFinishUser = document.getElementById("finishUser");

  if (elSplashName) elSplashName.textContent = shown;
  if (elWhoSplash)  elWhoSplash.textContent  = shown;
  if (elWhoRun)     elWhoRun.textContent     = shown;
  if (elHello)      elHello.textContent      = `Hello ${shown}`;
  if (elFinishUser && document.getElementById("finishOverlay")?.style?.display === "flex") elFinishUser.textContent = shown;

  showToast("Name saved ‚úÖ", 1100);
}

function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function jsSafe(s){ return String(s).replaceAll("\\","\\\\").replaceAll("'","\\'"); }
function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

/* Show only one section */
function showOnly(id){
  const ids = ["auth","splash","run"];
  ids.forEach(x => {
    const el = document.getElementById(x);
    if (el) el.style.display = (x === id) ? "flex" : "none";
  });
}

/* Logout confirm */
function logoutConfirm(){
  if (confirm("Log out?")) logout();
}
function logout(){
  teardownMap();
  sessionStorage.removeItem("hustle_role");
  sessionStorage.removeItem("hustle_user");
  sessionStorage.removeItem("");
  location.reload();
}

/* Time helpers */
function displayTime(iso){
  if (!iso) return "‚Äî";
  try { return new Date(iso).toLocaleString(); } catch(e){ return "‚Äî"; }
}
function timeAgo(iso){
  if (!iso) return "‚Äî";
  const t = new Date(iso).getTime();
  if (!isFinite(t)) return "‚Äî";
  const diff = Date.now() - t;
  const s = Math.floor(diff/1000);
  if (s < 10) return "just now";
  if (s < 60) return `${s}s ago`;
  const m = Math.floor(s/60);
  if (m < 60) return `${m}m ago`;
  const h = Math.floor(m/60);
  if (h < 48) return `${h}h ago`;
  const d = Math.floor(h/24);
  return `${d}d ago`;
}

/* Toast */
let toastTimer = null;
function showToast(msg, ms=1200){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove("show"), ms);
}

/* Saved indicator */
let savedTimer = null;
function flashSaved(){
  const el = document.getElementById("savedPill");
  if (!el) return;
  el.classList.add("show");
  clearTimeout(savedTimer);
  savedTimer = setTimeout(()=>el.classList.remove("show"), 900);
}

/* Completion pill */
let loggingLocked = false;

function isLoggingLocked(){
  return !!loggingLocked;
}

function setLoggingEnabled(enabled){
  loggingLocked = !enabled;

  // Disable/enable log controls
  document.querySelectorAll(".quickBtn, .addBtn").forEach(b => b.disabled = !enabled);
  const input = document.getElementById("input");
  if (input) input.disabled = !enabled;

  // Optional visual cue
  const wrap = document.querySelector(".quickRow");
  if (wrap) wrap.style.opacity = enabled ? "1" : "0.55";
}
function setCompletedUI(isDone){
  const pill = document.getElementById("completePill");
  if (!pill) return;
  pill.style.display = isDone ? "inline-flex" : "none";
}

/* Next moment text */
function updateNextMoment(loggedKm){
  const el = document.getElementById("nextMomentText");
  if (!el) return;

  const km = clamp(Number(loggedKm||0), 0, CHALLENGE_KM);
  if (km >= CHALLENGE_KM){
    el.textContent = "Next Hustle rep in: Completed üèÅ";
    return;
  }
  const nextInt = Math.min(CHALLENGE_KM, Math.floor(km) + 1);
  const remaining = Math.max(0, nextInt - km);
  el.textContent = `Next Hustle rep in: ${remaining.toFixed(2)} km`;
}

/* Progress UI */
function setProgressUI(km){
  const clamped = Math.max(0, Math.min(CHALLENGE_KM, Number(km||0)));
  document.getElementById("total").textContent = clamped.toFixed(2);
  const pct = (clamped / CHALLENGE_KM) * 100;
  document.getElementById("barFill").style.width = pct.toFixed(1) + "%";
  setCompletedUI(clamped >= CHALLENGE_KM);
  setLoggingEnabled(clamped < CHALLENGE_KM);
updateUndoButtonState();
  updateNextMoment(clamped);
}
function updateLastUpdateLabel(){
  const u = getUser();
  const data = getData();
  const iso = data?.[u]?.last_update || null;
  document.getElementById("lastUpdateText").textContent = iso ? displayTime(iso) : "‚Äî";
}
function updateUndoButtonState(){
  const u = getUser();
  const data = getData();
  const hist = data?.[u]?.history;
  const has = Array.isArray(hist) && hist.length > 0;
  const btn = document.getElementById("undoBtn");
  if (btn) btn.disabled = !has;
}

/* enable login button only when filled */
function updateLoginButton(){
  const u = (document.getElementById("username")?.value || "").trim();
  const p = (document.getElementById("password")?.value || "");
  const btn = document.getElementById("loginBtn");
  if (!btn) return;
  const ready = (u.length && p.length);
  // Some mobile editors/WebViews don't reliably re-enable disabled buttons.
  // So we NEVER hard-disable; we just change opacity to hint.
  btn.disabled = false;
  btn.style.opacity = ready ? "1" : "0.65";
}
document.addEventListener("DOMContentLoaded", function(){
  const u = document.getElementById("username");
  const p = document.getElementById("password");
  // If this file is viewed inside an editor preview that doesn't fire input events reliably,
  // the Login button is still clickable (we removed the disabled attribute in HTML).
  u && u.addEventListener("input", updateLoginButton);
  p && p.addEventListener("input", updateLoginButton);
  u && u.addEventListener("keydown", (e)=>{ if (e.key==="Enter"){ e.preventDefault(); p && p.focus(); }});
  p && p.addEventListener("keydown", (e)=>{ if (e.key==="Enter"){ e.preventDefault(); login(); }});
  updateLoginButton();
});;

/* LOGIN */
function login(){
  const codeRaw = (document.getElementById("accessCode")?.value || "").trim();
  if (!codeRaw){ alert("Enter your login code."); return; }

  if (codeRaw !== ACCESS_CODE){ alert("Wrong code (case sensitive)."); return; }

  const u = codeRaw; // store code as the user key

  const data = getData();
  if (!data[u]){
    data[u] = {
      km: 0,
      history: [],
      emails: [],
      last_update: null,
      finish_at: null,
      displayName: ""
    };
    saveData(data);
  }

  teardownMap();
  sessionStorage.setItem("hustle_role","user");
  sessionStorage.setItem("hustle_user",u);

  showOnly("splash");
  applyDisplayNameToUI();

  const savedKm = Math.min((data[u].km || 0), CHALLENGE_KM);
  const goal = (typeof CHALLENGE_KM === "number") ? CHALLENGE_KM : 17;
  const goalText = goal.toFixed ? goal.toFixed(2) : String(goal);
  document.getElementById("splashProgress").textContent = `Progress: ${savedKm.toFixed(2)} / ${goalText} km`;
  document.getElementById("startBtn").textContent = savedKm > 0 ? "Continue" : "Start";
}

/* HELP */
function openHelp(){ document.getElementById("helpOverlay").style.display = "flex"; }
function closeHelp(){ document.getElementById("helpOverlay").style.display = "none"; }

/* Back to top */
function backToTop(){ window.scrollTo({ top: 0, behavior: "smooth" }); }

/* =========================
   MAP + ROUTE + PROGRESS
========================= */

/* Near-closed circle route (doesn't quite connect) */
const START = [24.65, 12.65];

function haversineMeters(a, b){
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;
  const lat1 = toRad(a[0]), lat2 = toRad(b[0]);
  const dLat = toRad(b[0]-a[0]);
  const dLng = toRad(b[1]-a[1]);
  const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
  const x = s1*s1 + Math.cos(lat1)*Math.cos(lat2)*s2*s2;
  return 2*R*Math.asin(Math.min(1, Math.sqrt(x)));
}
function totalRouteMeters(route){
  let m = 0;
  for (let i=1;i<route.length;i++) m += haversineMeters(route[i-1], route[i]);
  return m;
}

/*
  Perfect circle-ish route with a small gap (start and end close but not touching).
  We generate points around a circle but stop short of a full 360¬∞.
*/
function generateCircleRouteBase(){
  const pts = [];

  // Circle size in "abstract units" (we scale to target meters afterwards)
  const R = 2.4;

  // How big the gap is (degrees). 18¬∞ = noticeable but still "almost connected"
  const GAP_DEG = 18;

  // Points density (more = smoother circle)
  const STEPS = 120;

  // XY -> lat/lng mapping (arbitrary; we scale afterwards anyway)
  const unitLat = 0.020;
  const unitLng = 0.020;

  function pushXY(x, y){
    pts.push([START[0] + y*unitLat, START[1] + x*unitLng]);
  }

  const startDeg = 90;                  // start at top
  const endDeg = startDeg + 360 - GAP_DEG;

  for (let i=0; i<=STEPS; i++){
    const a = (startDeg + (endDeg-startDeg)*(i/STEPS)) * Math.PI/180;
    const x = Math.cos(a) * R;
    const y = Math.sin(a) * R;
    pushXY(x, y);
  }

  // NOTE: Do NOT close the loop. End stays close to start, but doesn't touch.
  return pts;
}

function scaleRouteToMeters(route, targetMeters){
  const current = totalRouteMeters(route);
  if (!current || current < 1) return route;
  const scale = targetMeters / current;
  return route.map(pt => {
    const dLat = pt[0] - START[0];
    const dLng = pt[1] - START[1];
    return [START[0] + dLat * scale, START[1] + dLng * scale];
  });
}

const ROUTE = scaleRouteToMeters(generateCircleRouteBase(), TARGET_ROUTE_METERS);

// Decorative 17 overlay (not part of progress route)
// Decorative separate "1" and "7" overlays (visual only)
function generateDecorative1(){
  const pts = [];
  const unitLat = 0.045;
  const unitLng = 0.045;
  function pushXY(x,y){ pts.push([START[0] + y*unitLat, START[1] + x*unitLng]); }
  // "1"
  pushXY(-0.9, -0.9);
  pushXY(-0.9,  0.9);
  return pts;
}
function generateDecorative7(){
  const pts = [];
  const unitLat = 0.045;
  const unitLng = 0.045;
  function pushXY(x,y){ pts.push([START[0] + y*unitLat, START[1] + x*unitLng]); }
  // "7"
  pushXY(0.4, 0.9);
  pushXY(1.2, 0.9);
  pushXY(0.4, -0.9);
  return pts;
}





/* MAP STATE */
let map, redLine, greenLine, progressDot;
let distCum = [], totalMeters = 0;
let popped = new Set();
let lastLoggedDistance = null;

/* Map lock state */
let mapLocked = true;

/* Clean teardown so switching pages is safe */
function teardownMap(){
  try{
    if (map){
      map.off();
      map.remove();
    }
  }catch(e){}
  map = null;
  redLine = null;
  greenLine = null;
  progressDot = null;
  distCum = [];
  totalMeters = 0;
  popped = new Set();
  lastLoggedDistance = null;
  mapLocked = true;
}

/* Map lock/unlock */
function applyMapLockState(){
  if (!map) return;
  const mapEl = document.getElementById("map");

  if (mapLocked){
    map.scrollWheelZoom.disable();
    map.dragging.disable();
    map.touchZoom.disable();
    map.doubleClickZoom.disable();
    map.boxZoom.disable();
    map.keyboard.disable();
    if (map.tap) map.tap.disable();

    document.getElementById("mapLockBtn").textContent = "Unlock map";
    mapEl.classList.add("map-locked");
    mapEl.classList.remove("map-unlocked");
  } else {
    map.scrollWheelZoom.enable();
    map.dragging.enable();
    map.touchZoom.enable();
    map.doubleClickZoom.enable();
    map.boxZoom.enable();
    map.keyboard.enable();
    if (map.tap) map.tap.enable();

    document.getElementById("mapLockBtn").textContent = "Lock map";
    mapEl.classList.remove("map-locked");
    mapEl.classList.add("map-unlocked");
  }
}
function toggleMapLock(){
  mapLocked = !mapLocked;
  applyMapLockState();
  showToast(mapLocked ? "Map locked üîí (scroll page normally)" : "Map unlocked üó∫Ô∏è (move/zoom)", 1200);
}

/* START RUN */
function startRun(){
  const u = getUser() || "";
  showOnly("run");

  const shown = getDisplayName(u);
  document.getElementById("helloName").textContent = `Hello ${shown}`;
  document.getElementById("whoRun").textContent = shown;

  teardownMap();
  map = L.map("map", { zoomControl: true }).setView(START, 9);

  // Locked by default (better scrolling)
  mapLocked = true;
  applyMapLockState();

  const tiles = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png", {
    maxZoom: 19, subdomains: "abcd",
    attribution: "&copy; OpenStreetMap contributors &copy; CARTO"
  }).addTo(map);

  const loadingEl = document.getElementById("mapLoading");
  let hideDone = false;
  function hideLoading(){
    if (hideDone) return;
    hideDone = true;
    loadingEl.style.display = "none";
  }
  tiles.once("load", hideLoading);
  setTimeout(hideLoading, 3500);

  redLine = L.polyline(ROUTE, { color: getComputedStyle(document.documentElement).getPropertyValue('--routeLine').trim() || 'rgba(47,128,255,.95)', weight:3, opacity:0.88 }).addTo(map);

  // Decorative 17 overlay (visual only)
  const deco1 = L.polyline(generateDecorative1(), { color:'#F5C84C', weight:7, opacity:0.95, className:'shiny-route' }).addTo(map);
const deco7 = L.polyline(generateDecorative7(), { color:'#F5C84C', weight:7, opacity:0.95, className:'shiny-route' }).addTo(map);
greenLine = L.polyline([], { color: getComputedStyle(document.documentElement).getPropertyValue('--green').trim(), weight:6, opacity:0.95, className:'shiny-route' }).addTo(map);

  // Subtle pulsing progress dot (small + NO SCALE)
  progressDot = L.circleMarker(ROUTE[0], {
    radius: 4,
    weight: 2,
    color: getComputedStyle(document.documentElement).getPropertyValue('--green').trim(),
    fillColor: getComputedStyle(document.documentElement).getPropertyValue('--green').trim(),
    fillOpacity: 0.9,
    className: "pulse-dot"
  }).addTo(map);

  fitRoute();

  distCum = [0];
  totalMeters = 0;
  for (let i=1;i<ROUTE.length;i++){
    totalMeters += map.distance(ROUTE[i-1], ROUTE[i]);
    distCum.push(totalMeters);
  }

  const data = getData();
  const saved = Math.min((data[u]?.km || 0), CHALLENGE_KM);
  setProgressUI(saved);
  setProgressInstant(saved);
  updateLastUpdateLabel();

  if (saved >= CHALLENGE_KM){
    if (!data[u].finish_at) {
      data[u].finish_at = new Date().toISOString();
      data[u].last_update = data[u].finish_at;
      saveData(data);
      updateLastUpdateLabel();
    }
    showFinish();
  }
}

/* Map controls */
function recenter(){
  if (!map) return;
  map.setView(START, 9, { animate:true });
}
function fitRoute(){
  if (!map || !redLine) return;
  map.fitBounds(redLine.getBounds(), { padding:[26,26] });
}

/* PROGRESS helpers */
function metersForLoggedKm(loggedKm){
  const clamped = Math.max(0, Math.min(CHALLENGE_KM, loggedKm));
  return (clamped / CHALLENGE_KM) * totalMeters;
}
function pointAtMeters(m){
  if (m <= 0) return { pt: ROUTE[0], idx: 0 };
  if (m >= totalMeters) return { pt: ROUTE[ROUTE.length-1], idx: ROUTE.length-2 };

  let i=0;
  while (i < distCum.length-1 && distCum[i+1] < m) i++;

  const A = ROUTE[i], B = ROUTE[i+1];
  const t = (m - distCum[i]) / (distCum[i+1] - distCum[i]);
  return { pt: [A[0] + (B[0]-A[0])*t, A[1] + (B[1]-A[1])*t], idx: i };
}
function polyUpToMeters(m){
  const { pt, idx } = pointAtMeters(m);
  const base = ROUTE.slice(0, idx+1);
  base.push(pt);
  return base;
}
function setProgressInstant(loggedKm){
  if (!map || !greenLine || !progressDot) return;
  const m = metersForLoggedKm(loggedKm);
  const { pt } = pointAtMeters(m);
  greenLine.setLatLngs(polyUpToMeters(m));
  progressDot.setLatLng(pt);
}
function animateProgress(fromLoggedKm, toLoggedKm){
  const fromM = metersForLoggedKm(fromLoggedKm);
  const toM   = metersForLoggedKm(toLoggedKm);

  const frames = 170;
  let f = 0;

  function step(){
    f++;
    const t = Math.min(1, f/frames);
    const m = fromM + (toM - fromM) * t;

    const { pt } = pointAtMeters(m);
    greenLine.setLatLngs(polyUpToMeters(m));
    progressDot.setLatLng(pt);

    if (t < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* CONFIRM POPUP */

/* QUICK LOG (no confirmation) */
function requestQuick(km, btn){
  if (isLoggingLocked()) return;

  km = Number(km);
  if (!km || km <= 0) return;

  doLog(km);
}
function confirmAddKm(km){
  return confirm(`You are adding +${Number(km).toFixed(2)} km.\n\nPress OK to confirm.`);
}

/* Backwards compatibility: if anything still calls requestLog, treat it as quick (no confirm) */
function requestLog(km){ return requestQuick(km); }


/* LOG */
function requestLogWithConfirm(km){
  km = Number(km);
  if (!km || km <= 0) return;
  if (!confirmAddKm(km)) return;
  doLog(km);
}
function parseKmInput(raw){
  if (raw == null) return NaN;
  const s = String(raw).trim().replace(",", ".");
  if (!s) return NaN;
  return Number(s);
}
function requestLogFromInputConfirm(btn){
  // Lock logging once completed
  if (isLoggingLocked()) return;

  // Prevent accidental double-taps on the Add button
  if (btn && btn.dataset && btn.dataset.busy === "1") return;
  if (btn && btn.dataset) btn.dataset.busy = "1";

  const inputEl = document.getElementById("input");
  const v = parseKmInput(inputEl ? inputEl.value : "");
  if (!v || v <= 0) return;
  requestLogWithConfirm(v);
  if (btn && btn.dataset) setTimeout(()=>{ btn.dataset.busy = "0"; }, 900);
}

/* UNDO */
function undoLast(){
  const u = getUser();
  const data = getData();
  if (!data[u]) return;

  const hist = Array.isArray(data[u].history) ? data[u].history : [];
  if (!hist.length){
    showToast("Nothing to undo.", 1200);
    updateUndoButtonState();
    return;
  }

  const last = hist.at(-1);
  const lastKm = Number(last.km || 0);

  if (!confirm(`Undo last log (${lastKm.toFixed(2)} km)?`)) return;

  const before = Math.min(Number(data[u].km || 0), CHALLENGE_KM);
  const after  = clamp(before - lastKm, 0, CHALLENGE_KM);

  hist.pop();
  data[u].history = hist;
  data[u].km = after;

  if (after < CHALLENGE_KM) data[u].finish_at = null;

  data[u].last_update = new Date().toISOString();
  saveData(data);

  lastLoggedDistance = null;

  setProgressUI(after);
  setProgressInstant(after);
  updateLastUpdateLabel();

  popped = new Set();
  closeFinish();

  showToast(`Undone (-${lastKm.toFixed(2)} km)`, 1200);
  updateUndoButtonState();
}

/* LOG */
function doLog(addKm){
  const data = getData();
  const u = getUser();
  if (!data[u]) return alert("User not found.");

  const before = Math.min(Number(data[u].km || 0), CHALLENGE_KM);
  const after  = Math.min(before + addKm, CHALLENGE_KM);

  data[u].km = after;

  data[u].history = Array.isArray(data[u].history) ? data[u].history : [];
  const nowISO = new Date().toISOString();
  const nowLocal = new Date().toLocaleString();
  data[u].history.push({ atISO: nowISO, atLocal: nowLocal, km: addKm });

  data[u].last_update = nowISO;

  if (after >= CHALLENGE_KM && !data[u].finish_at){
    data[u].finish_at = nowISO;
  }

  saveData(data);
  lastLoggedDistance = addKm;

  setProgressUI(after);
  animateProgress(before, after);

  flashSaved();
  updateLastUpdateLabel();

  showToast(`Added +${addKm.toFixed(2)} km`, 1100);

  const inputElClear = document.getElementById("input");
  if (inputElClear) inputElClear.value = "";
  updateUndoButtonState();

  for (let k = Math.floor(before)+1; k <= Math.floor(after); k++){
    if (k < 1 || k > CHALLENGE_KM) continue;
    if (popped.has(k)) continue;
    popped.add(k);

    setTimeout(() => {
      const m = metersForLoggedKm(k);
      const { pt } = pointAtMeters(m);
      L.popup({ closeButton:true, autoClose:true })
        .setLatLng(pt)
        .setContent(refs[k-1])
        .openOn(map);
    }, POPUP_DELAY_MS);
  }

  if (after >= CHALLENGE_KM){
    setLoggingEnabled(false);
    setTimeout(()=>showFinish(), 450);
  }
}

/* EMAIL */
function recordEmailAttempt(user){
  const data = getData();
  if (!data[user]) return;
  data[user].emails = Array.isArray(data[user].emails) ? data[user].emails : [];
  const nowISO = new Date().toISOString();
  const nowLocal = new Date().toLocaleString();
  data[user].emails.push({ atISO: nowISO, atLocal: nowLocal });
  data[user].last_update = nowISO;
  saveData(data);
  updateLastUpdateLabel();
}
function emailToWRW(){
  // Opens an email draft for submitting completion proof
  const subject = `${RACE_NAME} Completed`;
  const body = [
    `Congrats on finishing ${RACE_NAME}!`,
    "",
    "Please fill in the details below:",
    "",
    "Forename:",
    "Surname:",
    "First line of address:",
    "",
    "Then attach your proof of completion.",
    "",
    "Medals are dispatched on the last Friday of each month.",
    "Proofs sent after the last Wednesday of the month will be dispatched in the following month."
  ].join("\n");

  const u = getUser() || "unknown";
  recordEmailAttempt(u);

  const mailto =
    `mailto:${encodeURIComponent(WRW_EMAIL)}` +
    `?subject=${encodeURIComponent(subject)}` +
    `&body=${encodeURIComponent(body)}`;

  window.location.href = mailto;
}

function copyProofEmail(){
  const el = document.getElementById("proofEmail");
  const txt = (el && el.textContent) ? el.textContent.trim() : (typeof WRW_EMAIL !== "undefined" ? WRW_EMAIL : "");
  if (!txt) return;
  if (navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(txt).then(()=>showToast("Copied email")).catch(()=>prompt("Copy this email:", txt));
  } else {
    prompt("Copy this email:", txt);
  }
}


/* FINISH */
function showFinish(){
  try{ const pe=document.getElementById("proofEmail"); if(pe && typeof WRW_EMAIL!=="undefined") pe.textContent=WRW_EMAIL; }catch(e){}
  const u = getUser() || "You";
  const data = getData();
  const obj = data[u] || {};
  const total = Math.min(Number(obj.km || 0), CHALLENGE_KM).toFixed(2);
  const whenISO = obj.finish_at || new Date().toISOString();
  const whenNice = (function(){
    try { return new Date(whenISO).toLocaleString(); } catch(e){ return "‚Äî"; }
  })();

  document.getElementById("finishUser").textContent = getDisplayName(u);
  document.getElementById("finishTotal").textContent = total;
  document.getElementById("finishWhen").textContent = whenNice;

  const fo = document.getElementById("finishOverlay");
  if (fo){ fo.classList.add("show"); fo.style.display = "flex"; }
}
function closeFinish(){ const fo=document.getElementById("finishOverlay"); if(fo){ fo.classList.remove("show"); fo.style.display="none"; } }

/* ===== Map comes back after leaving to email ===== */
function refreshMapAfterReturn(){
  if (!map) return;
  try{
    map.invalidateSize(true);
    // keep it tidy: if user comes back and it looks blank, fit once
    if (redLine) map.fitBounds(redLine.getBounds(), { padding:[26,26] });
  }catch(e){}
}
document.addEventListener("visibilitychange", ()=>{
  if (document.visibilityState === "visible"){
    setTimeout(refreshMapAfterReturn, 120);
    setTimeout(refreshMapAfterReturn, 420);
  }
});
window.addEventListener("focus", ()=>{
  setTimeout(refreshMapAfterReturn, 120);
});
window.addEventListener("pageshow", ()=>{
  setTimeout(refreshMapAfterReturn, 120);
});

/* Splash -> Run */
showOnly("auth");
</script>
</body>
</html>
